name: Aarch64

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build Wheel (${{ matrix.python-tag }}-manylinux_aarch64)
    runs-on: ubuntu-22.04-arm

    strategy:
      fail-fast: false
      matrix:
        python-tag: ["cp312", "cp313"]

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: true

      # Set up Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-tag | replace('cp', '').replace('','.') }}  # 3.12, 3.13

      # Install Conan
      - name: Install Conan
        run: python -m pip install --upgrade pip conan

      # Configure Conan profile for ARM64 + GCC
      - name: Configure Conan profile
        run: |
          conan profile new default --detect || true
          conan profile update settings.compiler=gcc default
          conan profile update settings.compiler.version=12 default
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan profile update settings.arch=armv8 default
          conan profile update settings.os=Linux default
          conan profile update settings.build_type=Release default
        shell: bash

      # Cache Conan packages
      - name: Cache Conan
        uses: actions/cache@v5
        with:
          path: ~/.conan2/p
          key: linux-aarch64-conan-${{ hashFiles('conanfile.py') }}
          restore-keys: |
            linux-aarch64-conan-

      # Build wheels
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.1
        env:
          CIBW_BUILD: ${{ matrix.python-tag }}-manylinux_aarch64
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          CIBW_ENVIRONMENT_PASS_LINUX: "CONAN_PROFILE"
          CIBW_ENVIRONMENT: >
            CXXFLAGS="-O2 -fPIC"
            CFLAGS="-O2 -fPIC"
            LDFLAGS=""
          CIBW_BEFORE_ALL: ""  # disable apt/LLVM install
          CIBW_REPAIR_WHEEL_COMMAND: auditwheel repair --strict -w {dest_dir} {wheel}
          CIBW_BUILD_VERBOSITY: 2

      # Fix Conan permissions
      - name: Fix Conan permissions
        run: sudo chown -R $USER:$USER ~/.conan2

      # Verify built wheels
      - name: Verify wheels
        run: |
          python -m pip install --upgrade auditwheel
          for whl in wheelhouse/*.whl; do
            auditwheel show "$whl"
          done

      # Upload wheels as artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: endstone-wheels-${{ matrix.python-tag }}-manylinux_aarch64
          path: wheelhouse/*.whl
