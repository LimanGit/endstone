name: aarch64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install cibuildwheel conan

      - name: Configure Conan
        run: |
          conan profile detect --force
          conan profile update settings.compiler.libcxx=libstdc++11 default

      - name: Build wheel (aarch64, Python 3.12)
        uses: pypa/cibuildwheel@v2.18.1
        env:
          CIBW_BUILD: cp312-manylinux_aarch64
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          CIBW_BUILD_VERBOSITY: 2
          CIBW_REPAIR_WHEEL_COMMAND: auditwheel repair -w {dest_dir} {wheel}

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: endstone-aarch64-cp312
          path: wheelhouse/*.whl
